function ChooseUpladAttachmentModle(){this.values={}}function ChooseUpladAttachmentVeiw(e){var t={id:"ChooseUpladAttachment",tri:"",viewDepositor:"body",pos:{left:0,top:0},onRequestAfter:function(){},onDelete:function(){}};this.settings=$.extend({},t,e),this.box=$(this.settings.tri),this.model=new ChooseUpladAttachmentModle,this.token=bs_tita.GoKuaiToken&&bs_tita.GoKuaiToken.Token?bs_tita.GoKuaiToken.Token:"",this.dtime=bs_tita.GoKuaiToken&&bs_tita.GoKuaiToken.DateTime?bs_tita.GoKuaiToken.DateTime:"",this.init()}var GKC4TITA_pass=!1;(function(){if(typeof bs_tita=="object"){if(!bs_tita.GoKuaiToken)return;var e=bs_tita&&bs_tita.GoKuaiToken&&bs_tita.GoKuaiToken.GoKuiUrl?bs_tita.GoKuaiToken.GoKuiUrl:"http://www.gokuai.com";bs_tita.GoKuaiToken.GoKuiUrl!="http://www.gokuai.com"?elSrc=e+"/Common/js/GKC4TITA.dev.js?_="+Math.random():elSrc=e+"/Common/js/GKC4TITA.js?_="+Math.random(),jQuery.getScript(elSrc,function(){GKC4TITA_pass=!0,EventManager.trigger("GKC4TITA_event")})}})(),ChooseUpladAttachmentModle.prototype={setValue:function(e,t){if(e==""||t=="")return;this.values["file_"+t]=e},setAllValue:function(e){this.values=e},getValue:function(){return this.values},getAllValue:function(){var e=[],t=this.getValue();for(i in t)e.push(t[i]);return e}},ChooseUpladAttachmentVeiw.prototype={defined:function(){this.HTML=['<div class="actionUploadAttachment" id="',this.settings.id,'_AUA">','<div class="local_auatth"><a href="javascript:void(0);">本地上传</a></div>','<div class="own_auatth"><a href="javascript:void(0);">从我的文件中选择</a></div>',"</div>"].join("")},reset:function(){this.model.setAllValue({}),this.box.find(".attachment_file_url").val("").attr("dfs","").data("fileList",{})},init:function(){this.model.setAllValue({}),this.defined(),this.addEevent()},addEevent:function(){var e=this,t=null,n=0;if(this.token==""||this.dtime=="")return!1;this._bulid(),this.box.unbind(".CUAV");var r=null,i=!1;this.box.delegate("input.file_formupoadfile","mouseover",function(){i=!0}),this.box.delegate("input.file_formupoadfile","mouseout",function(){i=!1}),this.box.bind("click",function(){n==0?(e.list.show(),n=1):(e.list.hide(),n=0)}),this.box.bind("mouseover.CUAV",function(){i=!0}).bind("mouseout.CUAV",function(){i=!1,r&&clearTimeout(r),r=setTimeout(function(){i||e.list.hide(),n=0},200)})},_bulid:function(){var e=this;this.list=$(this.HTML),this.local=this.list.find(".local_auatth"),this.own=this.list.find(".own_auatth"),this.box.css({position:"relative",cursor:"pointer"}),$(this.box).append(this.list),this._localFun(this.local,{pos:{left:-81,top:3}}),this.own.hide(),GKC4TITA_pass?(this.own.show(),this._ownFun()):EventManager.on("GKC4TITA_event",function(){e.own.show(),e._ownFun()})},_localFun:function(e,t){if(!e.length)return;var n=this;e.addAttachmentV2({id:this.settings.id,tipTri:this.box,viewDepositor:this.settings.viewDepositor,pos:{left:t.pos.left,top:t.pos.top},hoverClass:"hover_local_auatth",onSelect:function(){$(".actionUploadAttachment").hide(),window.TipT&&TipT.tip(null,null,{hide:!0})},onRequestAfter:function(e,t){n.model.setValue(e.dfs,t);if(n._validateFileNum())n.settings.onRequestAfter(n.model.getAllValue());else{var r=n.model.getAllValue();delete r["file_"+t],n.model.setAllValue(r)}},onDelete:function(e,t){var r=n.model.getValue();delete r["file_"+t],n.model.setAllValue(r),n.settings.onDelete(n.model.getAllValue())}})},_validateFileNum:function(e){return this.model.getAllValue().length>5?(e==1&&this._errorTip("最多只能上传5个文件，回复也可以上传"),!1):!0},_errorTip:function(e){var t=$('<div class="warnattachmenttip">'+e+"</div>"),n=$("#attachmentViewBox_"+this.settings.id);n.show(),t.prependTo(n).delay(3e3).slideUp(function(){t.remove()})},_ownFun:function(){var e=this,t=0;if(!this.own.length)return;var n=window["AATFV2_"+e.settings.id].bulideViewBox(e.settings.id,e.settings.viewDepositor);this.own.bind("click",function(){e._token();if(e.token==""){alert("从我的附件中选择 占时不能用");return}new GKC({token:e.token,ok:function(t){var r=t.filesize,i=t.filename.substring(t.filename.lastIndexOf(".")+1),s=(new Date).getTime(),o=e._createFileToken(s,t.filename);e.model.setValue(t.fullpath,o);if(e._validateFileNum(!0)){e.settings.onRequestAfter(e.model.getAllValue());var u=window["AATFV2_"+e.settings.id].buildViewerByToken(o),a=window["AATFV2_"+e.settings.id].bulidViewList({id:e.settings.id,fileType:i,fileName:t.filename,fileUrl:t.fullpath,token:o,isShowMinImg:!1});$(u).html(a),$(n).append(u).show();var f=e.box.find(".attachment_file_url"),l=f.val(),c=[];$.trim(l)!=""&&(c=l.split(",")),c.push(t.fullpath),f.val(c.join(","));var h=f.attr("dfs"),p=[];h&&h!=""&&(p=h.split(",")),p.push(t.fullpath),f.attr("dfs",p.join(",")),f.data("fileList")["file_"+o]=t.fullpath}else{var d=e.model.getValue();delete d["file_"+o],e.model.setAllValue(d)}},cancel:function(){e.model.setAllValue({})},style:{width:"660px",height:"556px",top:"50%",left:"50%",position:"fixed",marginLeft:"-330px",marginTop:"-278px",borderWidth:"6px",borderStyle:"solid",borderColor:"#80C3F0",backgroundColor:"#fff",borderRadius:0,zIndex:1e4}})})},_token:function(){var e=this;this._diffDate(this.dtime)||getXSSAjax($.ajax({type:"POST",url:createWebapiUrl("Document/GetToken"),success:function(t){t.Code==1?(e.token=t.Date.Token,e.dtime=t.Date.DateTime):(e.token="",e.dtime="")},error:function(){e.token="",e.dtime=""}}))},_bluidView:function(){var e='<div id="attachmentViewBox_'+this.settings.id+'" style="padding-top:8px"></div>';this.viewBox=this.box.find("#attachmentViewBox_"+this.settings.id),this.viewBox.length||($(e).hide().appendTo(this.box),this.viewBox=this.box.find("#attachmentViewBox_"+this.settings.id))},_diffDate:function(e){if(e=="")return;var t=new Date,n=e.split(" "),r=n[0].split("/"),i=n[1].split(":"),s=(new Date(r[0],r[1],r[2],i[0],i[1],i[2])).getTime()+18e6;return t>s||t==s?!1:!0},_createFileToken:function(e,t){return(e+encodeURIComponent(t)).replace(/[%\-\.!~\*'\(\)]/g,"")}};